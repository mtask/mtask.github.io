<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Monitoring Ruuvi tags with Raspberry Pi | Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Monitoring Ruuvi tags with Raspberry Pi" />
<meta name="author" content="mtask" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post shows how to deploy Raspberry Pi to fetch Ruuvi tag data and serve that data in a web application. Check this if you don’t know what Ruuvi tag is." />
<meta property="og:description" content="This post shows how to deploy Raspberry Pi to fetch Ruuvi tag data and serve that data in a web application. Check this if you don’t know what Ruuvi tag is." />
<link rel="canonical" href="http://localhost:4000/2020/12/18/raspberrypi-and-ruuvitag.html" />
<meta property="og:url" content="http://localhost:4000/2020/12/18/raspberrypi-and-ruuvitag.html" />
<meta property="og:site_name" content="Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-18T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Monitoring Ruuvi tags with Raspberry Pi" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Monitoring Ruuvi tags with Raspberry Pi","dateModified":"2020-12-18T00:00:00+02:00","datePublished":"2020-12-18T00:00:00+02:00","url":"http://localhost:4000/2020/12/18/raspberrypi-and-ruuvitag.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/12/18/raspberrypi-and-ruuvitag.html"},"author":{"@type":"Person","name":"mtask"},"description":"This post shows how to deploy Raspberry Pi to fetch Ruuvi tag data and serve that data in a web application. Check this if you don’t know what Ruuvi tag is.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/">/posts</a><a class="page-link" href="/whoami/">/whoami</a><a class="page-link" href="/categories/">/categories</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Monitoring Ruuvi tags with Raspberry Pi</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-12-18T00:00:00+02:00" itemprop="datePublished">Dec 18, 2020
      </time></p>
   </header>
  <div class="post-categories">
    
    [
    <a href="/categories/#Homelab">Homelab</a>
    
    ]
  </div>
  <div id="toc"></div>
  <div class="post-content e-content" itemprop="articleBody">
    <p>This post shows how to deploy Raspberry Pi to fetch Ruuvi tag data and serve that data in a web application. Check <a href="https://ruuvi.com/">this</a> if you don’t know what Ruuvi tag is.</p>

<p>The overall result is:</p>

<ul>
  <li>A python script to retrieve tag data and store it into an SQLite database.
    <ul>
      <li>The script uses the <a href="https://github.com/ttu/ruuvitag-sensor">ruuvitag-sensor</a> Python library to communicate with Ruuvi tags.</li>
    </ul>
  </li>
  <li>An API to serve the data.</li>
  <li>A Web application that consumes the API and displays the data in an HTML table.</li>
</ul>

<h2 id="what-you-need">What you need</h2>

<ol>
  <li>At least one Ruuvi tag.</li>
  <li>Raspberry Pi (I’m using model 3)
    <ul>
      <li>If you have an older version without Bluetooth capability, then an external Bluetooth adapter is needed.</li>
    </ul>
  </li>
</ol>

<h2 id="initial-setup">Initial setup</h2>

<p>Start <a href="https://www.raspberrypi.org/documentation/">here</a> if you need help with the initial Raspberry Pi setup.
The optimal starting point for this post is that you can SSH into your Pi. I have used the latest Raspbian Lite OS image in the examples of this post.</p>

<h2 id="install-dependencies">Install dependencies</h2>

<p>First install Python and bluetooth packages.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>python3-venv python3-pip bluez bluez-hcidump
</code></pre></div></div>

<p>Then create a Python3 virtual environment and activate it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> venv ruuvi
<span class="nb">source </span>ruuvi/bin/activate
</code></pre></div></div>

<p>Next install Python dependencies.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 <span class="nb">install </span>ruuvitag_sensor flask flask-bootstrap requests Flask-WTF
</code></pre></div></div>

<h2 id="collecting-tag-data">Collecting tag data</h2>

<p>Save the below script as <code class="language-plaintext highlighter-rouge">tag_to_sqlite.py</code>. The script fetches the latest data from a tag and stores that into a database.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span><span class="kn">from</span> <span class="nn">ruuvitag_sensor.ruuvi</span> <span class="kn">import</span> <span class="n">RuuviTagSensor</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">Error</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">get_tag_data</span><span class="p">(</span><span class="n">mac</span><span class="p">):</span>
    <span class="n">timeout_in_sec</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="n">RuuviTagSensor</span><span class="p">.</span><span class="n">get_data_for_sensors</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">timeout_in_sec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datas</span><span class="p">[</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">db_file</span><span class="p">):</span>
    <span class="s">""" create a database connection to the SQLite database
        specified by db_file
    :param db_file: database file
    :return: Connection object or None
    """</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">conn</span>


<span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">create_table_sql</span><span class="p">):</span>
    <span class="s">""" create a table from the create_table_sql statement
    :param conn: Connection object
    :param create_table_sql: a CREATE TABLE statement
    :return:
    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">create_table_sql</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">insert_tag_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"INSERT INTO ruuvidata VALUES (null,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"</span><span class="p">,</span> <span class="p">[</span><span class="n">dt</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="s">'data_format'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'humidity'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'temperature'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'pressure'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'acceleration'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'acceleration_x'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'acceleration_y'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'acceleration_z'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'tx_power'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'battery'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'movement_counter'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'measurement_sequence_number'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s">'mac'</span><span class="p">]])</span>
        <span class="n">conn</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"Give mac address as an argument"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s">'(?:[0-9a-fA-F]:?){12}'</span><span class="p">,</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"Give mac address as an argument"</span><span class="p">)</span>

    <span class="n">database</span> <span class="o">=</span> <span class="s">"/home/pi/ruuvitag.db"</span>

    <span class="n">sql_create_ruuvidata_table</span> <span class="o">=</span> <span class="s">""" CREATE TABLE IF NOT EXISTS ruuvidata (
                                        id integer PRIMARY KEY,
                                        time timestamp,
                                        data_format integer,
                    humidity real,
                    temperature real,
                    pressure real,
                    acceleration real,
                    acceleration_x integer,
                    acceleration_y integer,
                    acceleration_z integer,
                    tx_power integer,
                    battery integer,
                    movement_counter integer,
                    measurement_sequence_number integer,
                    mac text
                                    ); """</span>

    <span class="c1"># create a database connection
</span>    <span class="n">conn</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>

    <span class="c1"># create tables
</span>    <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">create_table</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">sql_create_ruuvidata_table</span><span class="p">)</span>
        <span class="n">insert_tag_data</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">get_tag_data</span><span class="p">([</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Error! cannot create the database connection."</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>Note the line <code class="language-plaintext highlighter-rouge">database = "/home/pi/ruuvitag.db"</code> in the main function. If you are not using the default <code class="language-plaintext highlighter-rouge">pi</code> user then change this to something else in here.</p>

<p>You can test the script by running <code class="language-plaintext highlighter-rouge">chmod 755 tag_to_sqlite.py &amp;&amp; ./tag_to_sqlite.py "&lt;your tag's MAC address in format XX:XX:XX:XX:XX:XX&gt;"</code>. As a result, the database should exist now and it should have one row populated with the sensor’s data. You can check this with <code class="language-plaintext highlighter-rouge">sudo apt install sqlite3 &amp;&amp; sqlite3 ruuvitag.db "select * from ruuvidata;"</code>.</p>

<p>You can find the MAC address of your Ruuvi tag with the Python library’s command-line tool or with Ruuvi Station mobile apps.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 ruuvi/lib/python3.7/site-packages/ruuvitag_sensor <span class="nt">-f</span>
</code></pre></div></div>

<h2 id="flask-api-and-ui">Flask API and UI</h2>
<p><a href="https://palletsprojects.com/p/flask/">The Flask web application framework</a> is an excellent choice when you want to get something quickly up and running.
First start by creating the below directory structure under <code class="language-plaintext highlighter-rouge">/home/pi/flasktag</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flasktag
├── forms
├── templates
└── util
</code></pre></div></div>

<p>This is the base folder structure for the API and UI apps.</p>

<h3 id="deploying-the-api">Deploying the API</h3>

<p>Next, create a file <code class="language-plaintext highlighter-rouge">flasktag/api.py</code> and add the following content to it. The API  is a very simple JSON based API that returns the requested amount of rows from the <code class="language-plaintext highlighter-rouge">ruuvitag.db</code> database.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">util.db</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">database</span> <span class="o">=</span> <span class="s">"../ruuvitag.db"</span>

<span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">value</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
            <span class="n">current</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/api/&lt;rows&gt;'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">ruuvi</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">values</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">prepare_data</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'127.0.0.1'</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div></div>

<p>Once again note the line <code class="language-plaintext highlighter-rouge">database = "../ruuvitag.db"</code> and change the path if it doesn’t match with your setup. If you check the code you can see that there is one endpoint <code class="language-plaintext highlighter-rouge">/api/&lt;rows&gt;</code> where the <code class="language-plaintext highlighter-rouge">rows</code> is amount of database rows you want to retrieve.</p>

<p>Next, create a file <code class="language-plaintext highlighter-rouge">flasktag/util/db.py</code> and add the following content to it. This file is a helper script that does the actual database communication.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">Error</span>

<span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">db_file</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn</span>

<span class="k">def</span> <span class="nf">get_data_internal</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * FROM ruuvidata ORDER BY id DESC LIMIT (?)'</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rows</span><span class="p">)])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">table</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">.</span><span class="n">description</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span><span class="n">table</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_data_internal</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="testing-the-api">Testing the API</h3>

<p>Navigate to the <code class="language-plaintext highlighter-rouge">flasktag</code> folder and run the API app with the command <code class="language-plaintext highlighter-rouge">python3 api.py</code>. You can launch this in background or in Screen or in a new ssh session. 
Then test the API with curl using the command <code class="language-plaintext highlighter-rouge">curl -s http:/127.0.0.1:8080/api/1 | python3 -m json.tool</code>. The command should return one database row in JSON format. The <code class="language-plaintext highlighter-rouge">| python3 -m json.tool</code> part is just for pretty printing.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -s http:/127.0.0.1:8080/api/1 | python3 -m json.tool
[
    {
        "acceleration": 1041.9213022104884,
        "acceleration_x": 20,
        "acceleration_y": -60,
        "acceleration_z": 1040,
        "battery": 3067,
        "data_format": 5,
        "humidity": 26.2,
        "id": 2,
        "mac": "e4c7751d5211",
        "measurement_sequence_number": 5466,
        "movement_counter": 18,
        "pressure": 1009.69,
        "temperature": 20.51,
        "time": "2020-12-18 00:29:06.094224",
        "tx_power": 4
    }
]
</code></pre></div></div>

<h3 id="deploying-the-ui">Deploying the UI</h3>

<p>The UI shows the data inside an HTML table. It uses the API in the background.  I did the separation in this way as I may want to use the API or some version of it to populate the data into some existing data visualization tool. The UI is mainly a proof of concept tool to view the data.</p>

<p>Now create the actual app file <code class="language-plaintext highlighter-rouge">flasktag/ui.py</code> with the below content:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="kn">from</span> <span class="nn">forms.RowForm</span> <span class="kn">import</span> <span class="n">RowForm</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'not-so-important-in-this-app'</span>
<span class="n">api</span> <span class="o">=</span> <span class="s">'http://127.0.0.1:8080/api'</span>
<span class="n">bootstrap</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">ruuviUI</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ruuvidata</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'GET'</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">RowForm</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">'row'</span><span class="p">])</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"{}/{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
            <span class="n">ruuvidata</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Error with the submitted row amount: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="n">ruuvidata</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">ruuvidata</span><span class="o">=</span><span class="n">ruuvidata</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">8888</span><span class="p">)</span> 
</code></pre></div></div>

<p>This file includes one view and it has two main functionalities depending on the HTTP method of a request. With the GET method, it returns a form that asks how many database rows the user wants to view. With the POST method, it returns the number of rows that were requested. So, in short, the user gives a number, and the data is shown in an HTML table.</p>

<p>Next create a file <code class="language-plaintext highlighter-rouge">flasktag/forms/RowForm.py</code> with the below content. This is a bluepring of the form that requests how many rows of data the user wants to view.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">SubmitField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span>

<span class="k">class</span> <span class="nc">RowForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'How many rows to fetch?'</span><span class="p">,</span> <span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s">'Submit'</span><span class="p">)</span>
</code></pre></div></div>

<p>Finally, create a file <code class="language-plaintext highlighter-rouge">flasktag/templates/index.html</code> with the below content and then everything is ready. This is the only HTML page that the UI has.</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">{% extends 'bootstrap/base.html' %}


{% block head %}
    {{ super() }}
    <span class="nt">&lt;title&gt;</span>{% block title %}{% endblock %} - RuuviTag data<span class="nt">&lt;/title&gt;</span>
{% endblock %}
{% block navbar %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar navbar-inverse"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">".navbar-collapse"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Navbar<span class="nt">&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
                <span class="nt">&lt;/button&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>RuuviTag data<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
{% endblock %}
{% block content %}
{% if form %}
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"jumbotron"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
        {{ form.hidden_tag() }}
        <span class="nt">&lt;p&gt;</span>
            {{ form.row.label }}<span class="nt">&lt;br&gt;</span>
            {{ form.row(size=22) }}<span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;p&gt;</span>{{ form.submit() }}<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
{% else %}
{% if ruuvidata %}
<span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"table"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>TIME<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>TEMPERATURE<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>HUMIDITY<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>MAC<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>
    <span class="nt">&lt;tbody&gt;</span>
        {% for row in ruuvidata %}
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{ row['time'] }}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{ row['temperature'] }}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{ row['humidity'] }}<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{ row['mac'] }}<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        {% endfor %}
    <span class="nt">&lt;/tbody&gt;</span>
{% else %}
<span class="nt">&lt;p&gt;</span>
Failed to fetch ruuvidata.
<span class="nt">&lt;/p&gt;</span>
{% endif %}
{% endif %}
{% endblock %}</code></pre></figure>

<h3 id="testing-the-ui">Testing the UI</h3>

<p>Ensure that your current working directory is <code class="language-plaintext highlighter-rouge">&lt;path&gt;/flasktag</code>. Then launch the API in background and the UI after that.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 api.py &amp;
python3 ui.py
</code></pre></div></div>

<p>Open your browser and navigate to <code class="language-plaintext highlighter-rouge">http://&lt;raspberry IP&gt;:8888/</code>.</p>

<p>You should see this.</p>

<p><img src="/assets/piandruuvitag1.png" alt="" />
When you submit the form, then you should see something like this.</p>

<p><img src="/assets/piandruuvitag2.png" alt="" /></p>

<h3 id="automate-data-gathering">Automate data gathering</h3>

<p>You can use Cron or Systemd timers to populate the database with new data. I tested this with a simple cron job that launches the <code class="language-plaintext highlighter-rouge">tag_to_sqlite.py</code> script every five minutes. Making the virtualenv to work inside the Cron job gave some challenges. I “fixed” this, for now, just by installing the python dependencies globally for the user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cron job to populate the data</span>
<span class="k">*</span>/5 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /usr/bin/python3 /home/pi/tag_to_sqlite.py <span class="s2">"&lt;tag's MAC address&gt;"</span>
</code></pre></div></div>


  </div><a class="u-url" href="/2020/12/18/raspberrypi-and-ruuvitag.html" hidden></a>
</article>

<!-- TOC -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/toc.js"></script>

<script type="text/javascript">
$(document).ready(function() {
    $('#toc').toc();
});
</script>


<!-- mermaid -->
<script>
var config = {
    startOnLoad:true,
    theme: 'forest',
    flowchart:{
            useMaxWidth:false,
            htmlLabels:true
        }
};
mermaid.initialize(config);
window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
</script>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">mtask</li>
          <li><a class="u-email" href="mailto:mtask.gh@protonmail.com">mtask.gh@protonmail.com</a></li><li><a href="/files/publickey.mtask.gh@protonmail.com.asc">8949b98a4e63585fe3bf6a953b9fd3e9ad04482e (gpg)</a></li></ul>
      </div>
      <div class="footer-col">
        <p>cybersecurity, homelab tinkering, etc.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/mtask" title="mtask"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
